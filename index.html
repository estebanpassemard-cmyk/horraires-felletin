<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ProTrack V95 ‚Ä¢ FINAL FIX</title>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: #0f172a; color: white; font-family: sans-serif; margin: 0; padding-bottom: 90px; }
        .version-tag { position: absolute; top: 10px; right: 10px; font-size: 11px; color: #10b981; font-weight: bold; }
        .nav { position: fixed; bottom: 0; width: 100%; height: 75px; background: #1e293b; display: flex; border-top: 1px solid #475569; z-index: 9999; }
        .nav-item { flex: 1; color: #64748b; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; font-size: 11px; cursor: pointer; }
        .nav-item.active { color: #3b82f6; border-top: 3px solid #3b82f6; background: rgba(59, 130, 246, 0.1); }
        .page { display: none; padding: 15px; width: 100%; }
        .card { background: #1e293b; border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #334155; position: relative; }
        .card.is-pending { border-left: 6px solid #3b82f6; border-right: 6px solid #3b82f6; }
        .card.is-billed { border: 2px solid #10b981; border-left: 6px solid #10b981; border-right: 6px solid #10b981; background: rgba(16, 185, 129, 0.03); }
        .project-title { color: #facc15; font-size: 20px; font-weight: 900; text-transform: uppercase; display: block; margin-bottom: 8px; }
        .type-tag { color: #94a3b8; font-size: 10px; font-weight: bold; text-transform: uppercase; margin-right: 5px; }
        .input { background: #0f172a; border: 1px solid #475569; color: white; border-radius: 6px; padding: 10px; width: 100%; font-size: 16px; margin-bottom: 10px; display: block; }
        #in-proj { font-size: 13px; font-weight: bold; }
        .btn { background: #2563eb; color: white; padding: 15px; border-radius: 10px; font-weight: bold; border: none; font-size: 16px; width: 100%; margin-top: 5px; cursor: pointer; }
        .btn-sec { background: #475569; padding: 12px 5px; font-size: 10px; color: white; border-radius: 6px; text-align: center; font-weight: bold; flex: 1; border: none; cursor: pointer; text-transform: uppercase; }
        .row-item { border-bottom: 1px solid #334155; padding: 10px 0; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .flex-row { display: flex; gap: 5px; align-items: center; margin-bottom: 10px; }
        .label { font-size: 11px; color: #94a3b8; margin-bottom: 5px; text-transform: uppercase; font-weight: bold; }
        .del-btn { color: #ef4444; border: none; background: none; font-size: 18px; cursor: pointer; padding-left: 10px; }
        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:10000; padding:15px; align-items:start; overflow-y: auto; }
        textarea { background: #0f172a; color: #10b981; border: 1px solid #475569; width: 100%; height: 300px; font-family: monospace; font-size: 11px; padding: 10px; margin-top: 10px; border-radius: 6px; line-height: 1.5; }
        .top-bar { display: flex; gap: 10px; margin-bottom: 15px; }
        .icon-btn { background: #1e293b; padding: 10px; border-radius: 10px; cursor: pointer; font-size: 22px; border: 1px solid #334155; position: relative; }
        .save-badge { position: absolute; top: -5px; right: -5px; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; font-weight: bold; border: 1px solid #0f172a; }
        .toggle-row { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; font-size: 13px; color: #3b82f6; font-weight: bold; }
        #bloc3, #bloc-demi { display: none; }
        .item-suivi { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #334155; background: rgba(0,0,0,0.1); margin-bottom: 2px; border-radius: 4px; }
        .item-suivi.noted { opacity: 0.5; border-left: 4px solid #10b981; background: rgba(16, 185, 129, 0.05); }
        .btn-check { background: #334155; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-check.active { background: #10b981; }
    </style>
</head>
<body>

    <div id="pg0" class="page" style="display:block;">
        <div class="version-tag">V95 ‚Ä¢ FINAL FIX</div>
        <div class="top-bar">
            <div class="icon-btn" onclick="openSet()">‚öôÔ∏è</div>
            <div class="icon-btn" onclick="openSave()">
                üíæ<span id="save-counter" class="save-badge">0</span>
            </div>
        </div>
        
        <div class="card">
            <div class="grid">
                <input type="date" id="in-date" class="input">
                <input type="text" id="in-proj" placeholder="PROJET" class="input" list="proj-list" autocomplete="off">
                <datalist id="proj-list"></datalist>
            </div>
            <select id="in-type" class="input" onchange="checkType()">
                <option value="Production">Production</option>
                <option value="Trajet">Trajet</option>
                <option value="Pige montage/d√©montage">Pige montage/d√©montage</option>
                <option value="Pige Omnes">Pige Omnes</option>
                <option value="Jours OFF">Jours OFF</option>
            </select>
            <div id="bloc-demi" class="toggle-row" style="color:#facc15;"><input type="checkbox" id="check-demi"><label for="check-demi">Demi-pige (1/2 tarif)</label></div>
            <div class="toggle-row"><input type="checkbox" id="check-long" onchange="toggleLong()"><label for="check-long">Journ√©e √† rallonge</label></div>
            <div class="label">Matin</div>
            <div class="flex-row"><input type="time" id="s1" class="input"><input type="time" id="e1" class="input"></div>
            <div class="label">Apr√®s-midi</div>
            <div class="flex-row"><input type="time" id="s2" class="input"><input type="time" id="e2" class="input"></div>
            <div id="bloc3"><div class="label">Soir</div><div class="flex-row"><input type="time" id="s3" class="input"><input type="time" id="e3" class="input"></div></div>
            <button class="btn" onclick="addItem()">ENREGISTRER</button>
        </div>
        <div id="recent-list"></div>
    </div>

    <div id="pg1" class="page">
        <div class="grid" style="margin-bottom:15px;">
            <div class="card" style="margin:0; text-align:center;"><div class="label">√Ä Facturer</div><div id="sum-af" style="font-size:18px; font-weight:bold; color:#ef4444;">0‚Ç¨</div></div>
            <div class="card" style="margin:0; text-align:center;"><div class="label" style="color:#10b981;">Factur√©</div><div id="sum-f" style="font-size:18px; font-weight:bold; color:#10b981;">0‚Ç¨</div></div>
        </div>
        <div id="list-bilan"></div>
    </div>

    <div id="pg3" class="page">
        <div id="list-suivi"></div>
    </div>

    <div id="pg2" class="page">
        <div id="list-archive"></div>
    </div>

    <div class="nav">
        <div id="nv0" class="nav-item active" onclick="go(0)"><span>Saisie</span></div>
        <div id="nv1" class="nav-item" onclick="go(1)"><span>Bilan</span></div>
        <div id="nv3" class="nav-item" onclick="go(3)"><span>Suivi</span></div>
        <div id="nv2" class="nav-item" onclick="go(2)"><span>Archives</span></div>
    </div>

    <div id="set-modal" class="modal">
        <div class="card" style="width:100%; margin-top:20px;">
            <h3>R√âGLAGES & CLOUD</h3>
            <div id="price-inputs"></div>
            <hr style="border:0; border-top:1px solid #475569; margin:15px 0;">
            <button id="btn-sync" class="btn" style="background:#10b981;" onclick="syncAllToCloud()">SYNCHRONISER TOUT L'HISTORIQUE</button>
            <p id="sync-status" style="font-size:10px; color:#94a3b8; text-align:center;">Envoie vos donn√©es vers Sheets.</p>
            <button class="btn" style="background:#475569; margin-top:10px;" onclick="closeSet()">FERMER</button>
        </div>
    </div>

    <div id="save-modal" class="modal">
        <div class="card" style="width:100%; margin-top:20px;">
            <h3>EXPORT TEXTE</h3>
            <select id="export-choice" class="input"></select>
            <button class="btn" style="background:#10b981; margin-bottom:10px" onclick="generatePrintable()">G√âN√âRER R√âCAP</button>
            <textarea id="backup-zone" readonly></textarea>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;"><button class="btn-sec" style="background:#3b82f6; padding:15px;" onclick="copyToClipboard()">COPIER</button><button class="btn-sec" style="padding:15px;" onclick="closeSave()">FERMER</button></div>
        </div>
    </div>

    <script>
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwMyxNPx2tdPV7mlXJxARd6M1WI0U4B1lPlRY1AM-kcuKgQ83gIA4O1P_o3kZpcWece/exec"; 

        var db = JSON.parse(localStorage.getItem('P69S_DATA') || '[]');
        var billed = JSON.parse(localStorage.getItem('P69S_BILL') || '[]');
        var archived = JSON.parse(localStorage.getItem('P69S_ARCH') || '[]');
        var rates = JSON.parse(localStorage.getItem('P69S_RT')) || { prod: 25, trajet: 20, piges: 350, omnes: 300, off: 100 };
        var lastSave = localStorage.getItem('P69S_LSAVE') || new Date().getTime();

        function go(n) { 
            // Masque toutes les pages
            document.getElementById('pg0').style.display = 'none';
            document.getElementById('pg1').style.display = 'none';
            document.getElementById('pg2').style.display = 'none';
            document.getElementById('pg3').style.display = 'none';
            // Affiche la bonne
            document.getElementById('pg' + n).style.display = 'block';
            
            // Met √† jour la classe active sur la nav
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('nv' + n).classList.add('active');
            
            updateSaveCounter(); 
            draw(); 
        }

        function updateSaveCounter() { var d = Math.floor((new Date().getTime()-lastSave)/(864e5)); var b = document.getElementById('save-counter'); b.innerText = d; b.style.background = d>=7?"#ef4444":(d>=3?"#f59e0b":"#3b82f6"); }
        function checkType() { document.getElementById('bloc-demi').style.display = document.getElementById('in-type').value.includes('Pige') ? 'flex' : 'none'; }
        function toggleLong() { document.getElementById('bloc3').style.display = document.getElementById('check-long').checked ? 'block' : 'none'; }
        function toM(v) { if(!v) return -1; var s = v.split(':'); return parseInt(s[0])*60+parseInt(s[1]); }

        function sendToCloud(item) {
            if(!GOOGLE_SCRIPT_URL) return;
            fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(item) }).catch(e => console.log("Cloud Error"));
        }

        async function syncAllToCloud() {
            if(db.length === 0) { alert("Aucune donn√©e."); return; }
            if(confirm("Envoyer vos " + db.length + " lignes vers Google Sheets ? (L'envoi sera progressif)")) {
                const btn = document.getElementById('btn-sync');
                const status = document.getElementById('sync-status');
                btn.disabled = true;
                btn.style.opacity = "0.5";
                for (let i = 0; i < db.length; i++) {
                    status.innerText = "Envoi : " + (i+1) + " / " + db.length;
                    sendToCloud(db[i]);
                    await new Promise(r => setTimeout(r, 400));
                }
                btn.disabled = false; btn.style.opacity = "1";
                status.innerText = "Synchronisation termin√©e !";
                alert("Termin√© ! V√©rifiez votre Google Sheet.");
            }
        }

        function addItem() {
            var d = document.getElementById('in-date').value, p = document.getElementById('in-proj').value.toUpperCase() || "DIVERS", t = document.getElementById('in-type').value;
            var isDemi = document.getElementById('check-demi').checked && t.includes('Pige');
            if(!d) return; 
            var s1=toM(document.getElementById('s1').value), e1=toM(document.getElementById('e1').value), s2=toM(document.getElementById('s2').value), e2=toM(document.getElementById('e2').value), s3=toM(document.getElementById('s3').value), e3=toM(document.getElementById('e3').value);
            var newItem = { id: new Date().getTime(), d: d, p: p, t: t, noted: false, isDemi: isDemi };
            if(t.includes('Pige') || t === 'Jours OFF') {
                var base = (t.includes('montage')) ? rates.piges : (t.includes('Omnes') ? rates.omnes : rates.off);
                newItem.val = isDemi ? base/2 : base; newItem.hStr = isDemi ? t+" (1/2)" : t; newItem.dur = 0;
            } else {
                function diff(a, b) { if(a===-1||b===-1) return 0; let r=b-a; return r<0?r+1440:r; }
                var tot = diff(s1,e1)+diff(s2,e2)+diff(s3,e3);
                var hp = []; if(diff(s1,e1)>0) hp.push(document.getElementById('s1').value+"-"+document.getElementById('e1').value); if(diff(s2,e2)>0) hp.push(document.getElementById('s2').value+"-"+document.getElementById('e2').value); if(diff(s3,e3)>0) hp.push(document.getElementById('s3').value+"-"+document.getElementById('e3').value);
                newItem.dur = tot/60; if(newItem.dur<=0) return;
                newItem.val = newItem.dur*(t==='Production'?rates.prod:rates.trajet); newItem.hStr = hp.join(' | ');
            }
            sendToCloud(newItem);
            db.unshift(newItem); localStorage.setItem('P69S_DATA', JSON.stringify(db));
            ['in-proj','s1','e1','s2','e2','s3','e3'].forEach(id => document.getElementById(id).value = "");
            document.getElementById('check-long').checked = false; document.getElementById('check-demi').checked = false; toggleLong(); checkType(); draw();
        }

        function draw() {
            var pl = []; db.forEach(o => { if(!pl.includes(o.p)) pl.push(o.p); });
            document.getElementById('proj-list').innerHTML = pl.map(x => '<option value="'+x+'">').join('');
            var rec = ""; for(var r=0; r<Math.min(db.length, 3); r++){ var o = db[r]; rec += `<div class="card" style="font-size:11px; margin-bottom:10px;"><b>${o.p}</b><span style="float:right;">${o.val.toFixed(2)}‚Ç¨</span><br><span style="color:#94a3b8;">${o.d.split('-').reverse().join('/')} | ${o.hStr}</span></div>`; }
            document.getElementById('recent-list').innerHTML = rec;
            var hB="", hA="", hS="", tAF=0, tF=0, groups = {};
            db.forEach(it => { groups[it.p] = groups[it.p] || []; groups[it.p].push(it); });
            for (var proj in groups) {
                var isB = billed.includes(proj), isA = archived.includes(proj), tot = 0, lines = "", sorted = groups[proj].sort((a, b) => new Date(a.d) - new Date(b.d));
                sorted.forEach(it => { tot += it.val; lines += `<div class="row-item"><div style="display:flex; justify-content:space-between; align-items:start;"><div><b>${it.d.split('-').reverse().join('/')}</b><br><span class="type-tag">${it.t}</span> ${it.dur>0?it.dur.toFixed(2)+'H':''}<br><small style="color:#94a3b8">${it.hStr}</small></div><div style="text-align:right;"><b style="font-size:14px;">${it.val.toFixed(2)}‚Ç¨</b><button class="del-btn" onclick="del(${it.id})">üóëÔ∏è</button></div></div></div>`; });
                if(!isA) { if(isB) tF += tot; else tAF += tot; }
                var card = `<div class="card ${isB?'is-billed':'is-pending'}"><span class="project-title">${proj}</span><div style="margin-bottom:10px; font-weight:bold; font-size:18px;">TOTAL : ${tot.toFixed(2)}‚Ç¨</div>${lines}<div style="display:flex; gap:10px; margin-top:15px;"><button class="btn-sec" onclick="tB('${proj}')">${isB?'√Ä FACTURER':'FACTUR√â'}</button><button class="btn-sec" onclick="tA('${proj}')">${isA?'R√âACTIVER':'ARCHIVER'}</button></div></div>`;
                if(isA) hA += card; else hB += card;
                if(!isA) {
                    var itsH = ""; sorted.forEach(it => { var lbl = it.dur>0?it.dur.toFixed(2)+'h':(it.isDemi?'0.5j':'1j'); itsH += `<div class="item-suivi ${it.noted?'noted':''}"><div><b>${it.d.split('-').reverse().join('/')}</b> - ${it.t}<br><span style="color:#3b82f6; font-weight:bold;">${lbl}</span></div><button class="btn-check ${it.noted?'active':''}" onclick="toggleLine(${it.id})">${it.noted?'‚úÖ':'‚ö™'}</button></div>`; });
                    hS += `<div class="card"><span class="project-title">${proj}</span>${itsH}</div>`;
                }
            }
            document.getElementById('list-bilan').innerHTML = hB || "Aucun projet."; document.getElementById('list-archive').innerHTML = hA || "Aucune archive."; document.getElementById('list-suivi').innerHTML = hS || "Aucun projet actif.";
            document.getElementById('sum-af').innerText = tAF.toFixed(2) + "‚Ç¨"; document.getElementById('sum-f').innerText = tF.toFixed(2) + "‚Ç¨";
        }

        window.toggleLine = function(id) { var item = db.find(it => it.id === id); if(item) { item.noted = !item.noted; localStorage.setItem('P69S_DATA', JSON.stringify(db)); draw(); } };
        window.tB = function(p) { if(billed.includes(p)) billed = billed.filter(x => x!==p); else billed.push(p); localStorage.setItem('P69S_BILL', JSON.stringify(billed)); draw(); };
        window.tA = function(p) { if(archived.includes(p)) archived = archived.filter(x => x!==p); else archived.push(p); localStorage.setItem('P69S_ARCH', JSON.stringify(archived)); draw(); };
        function del(id) { if(confirm("Supprimer cette ligne ?")) { db = db.filter(o => o.id !== id); localStorage.setItem('P69S_DATA', JSON.stringify(db)); draw(); } }
        function openSet() { var h = ""; for(var k in rates) { h += `<label class="label">${k}</label><input type="number" id="rt-${k}" value="${rates[k]}" class="input">`; } document.getElementById('price-inputs').innerHTML = h; document.getElementById('set-modal').style.display = 'flex'; }
        function closeSet() { for(var k in rates) { rates[k] = parseFloat(document.getElementById('rt-'+k).value) || 0; } localStorage.setItem('P69S_RT', JSON.stringify(rates)); document.getElementById('set-modal').style.display = 'none'; draw(); }
        function openSave() { var s = document.getElementById('export-choice'); var pj = [...new Set(db.filter(it => !archived.includes(it.p)).map(it => it.p))]; var opt = '<option value="ALL">TOUS LES PROJETS ACTIFS</option>'; pj.forEach(p => opt += `<option value="${p}">${p}</option>`); s.innerHTML = opt; document.getElementById('save-modal').style.display = 'flex'; }
        function closeSave() { document.getElementById('save-modal').style.display = 'none'; }
        function generatePrintable() { lastSave = new Date().getTime(); localStorage.setItem('P69S_LSAVE', lastSave); updateSaveCounter(); var ch = document.getElementById('export-choice').value, grp = {}; db.filter(it => !archived.includes(it.p)).forEach(it => { if(ch === "ALL" || it.p === ch) { grp[it.p] = grp[it.p] || []; grp[it.p].push(it); } }); var txt = "--- R√âCAPITULATIF AU " + new Date().toLocaleDateString() + " ---\n\n"; for (var pr in grp) { var pT = 0; txt += "PROJET : " + pr + "\n--------------------------------\n"; grp[pr].sort((a, b) => new Date(a.d) - new Date(b.d)).forEach(i => { txt += `${i.d.split('-').reverse().join('/')} | ${i.t}${i.isDemi?' (1/2)':''} ${i.dur>0?"("+i.dur.toFixed(2)+"h)":""}\nDetail: ${i.hStr}\n${i.val.toFixed(2)}‚Ç¨\n----------------\n`; pT += i.val; }); txt += "TOTAL PROJET : " + pT.toFixed(2) + "‚Ç¨\n\n\n"; } document.getElementById('backup-zone').value = txt; }
        function copyToClipboard() { var t = document.getElementById("backup-zone"); t.select(); document.execCommand("copy"); alert("Copi√© !"); }
        document.getElementById('in-date').valueAsDate = new Date(); updateSaveCounter(); draw();
    </script>
</body>
</html>
